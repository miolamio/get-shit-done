---
phase: 02-auth
plan: 01
type: execute
wave: 1
depends_on: [01-01]
files_modified: [src/lib/auth.ts, src/app/api/auth/register/route.ts, src/app/api/auth/login/route.ts, src/middleware.ts, prisma/schema.prisma]
autonomous: true
requirements: [AUTH-01, AUTH-02]

must_haves:
  truths:
    - "User can register with email and password via POST /api/auth/register"
    - "User can log in with valid credentials via POST /api/auth/login"
    - "Protected API routes return 401 for unauthenticated requests"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "JWT token generation and verification helpers"
      exports: ["signToken", "verifyToken"]
    - path: "src/app/api/auth/register/route.ts"
      provides: "User registration endpoint"
      exports: ["POST"]
    - path: "src/app/api/auth/login/route.ts"
      provides: "User login endpoint"
      exports: ["POST"]
    - path: "src/middleware.ts"
      provides: "Route protection middleware"
      contains: "verifyToken"
  key_links:
    - from: "src/app/api/auth/register/route.ts"
      to: "prisma.user"
      via: "prisma.user.create for registration"
      pattern: "prisma\\.user\\.create"
    - from: "src/app/api/auth/login/route.ts"
      to: "src/lib/auth.ts"
      via: "signToken for JWT generation"
      pattern: "signToken"
    - from: "src/middleware.ts"
      to: "src/lib/auth.ts"
      via: "verifyToken for route protection"
      pattern: "verifyToken"
---

<objective>
Implement JWT-based authentication with user registration, login, and route protection.

Purpose: Enable secure user access so only authenticated users can interact with the task management features.
Output: Auth utility library, register/login API endpoints, and Next.js middleware for route protection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/lib/db.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: JWT auth utilities and password hashing</name>
  <files>src/lib/auth.ts</files>
  <action>Create auth utility module with: (1) signToken(userId) — generates JWT with 15-min expiry using jose library, (2) verifyToken(token) — validates JWT and returns payload, (3) hashPassword(password) — bcrypt hash with 10 salt rounds, (4) comparePassword(password, hash) — bcrypt comparison. Use jose for JWT (Edge-compatible) and bcryptjs for hashing. Install both as dependencies.</action>
  <verify>Unit tests pass for all four functions: signToken returns string, verifyToken decodes correctly, hashPassword produces different output than input, comparePassword returns true for matching pair</verify>
  <done>Auth utilities exported and tested with jose JWT and bcryptjs hashing</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Registration and login API endpoints</name>
  <files>src/app/api/auth/register/route.ts, src/app/api/auth/login/route.ts, src/middleware.ts</files>
  <action>Create POST /api/auth/register: validate email/password, check for existing user, hash password, create user via Prisma, return JWT in httpOnly cookie. Create POST /api/auth/login: find user by email, compare password, return JWT in httpOnly cookie on success, 401 on failure. Create src/middleware.ts: check for JWT cookie on protected routes (/api/tasks/*, /dashboard/*), verify token, return 401 if invalid or missing. Use Next.js middleware matcher config.</action>
  <verify>curl POST /api/auth/register with valid body returns 201 + set-cookie header. curl POST /api/auth/login with valid credentials returns 200 + set-cookie. curl GET /api/tasks without cookie returns 401.</verify>
  <done>Register/login endpoints work with JWT cookies, middleware protects routes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no type errors
- [ ] POST /api/auth/register creates user in database
- [ ] POST /api/auth/login returns JWT for valid credentials
- [ ] Protected routes return 401 without valid JWT
- [ ] All tests pass
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Auth flow works end-to-end: register -> login -> access protected route
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth/02-01-SUMMARY.md`
</output>
